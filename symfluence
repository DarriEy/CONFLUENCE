#!/bin/bash
#
# SYMFLUENCE Shell Wrapper with Python Environment Management
# 
# This script provides a convenient command-line interface for SYMFLUENCE
# without requiring users to type "python symfluence.py" each time.
#
# Usage: symfluence [options]
# Example: symfluence --calibrate_model --debug
#

set -e  # Exit on any error

# Configuration
SCRIPT_NAME="symfluence"
SYMFLUENCE_SCRIPT="symfluence.py"
MIN_PYTHON_VERSION="3.11"
REQUIRED_PYTHON_VERSION="3.11"  # Preferred Python version

# Colors for output (if terminal supports it)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

# Function to print colored output
print_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

print_info() {
    echo -e "${BLUE}Info:${NC} $1"
}

print_success() {
    echo -e "${GREEN}Success:${NC} $1"
}

# Function to auto-detect and setup R environment for rpy2
setup_r_environment() {
    print_info "Auto-detecting R environment..."
    
    # Check if R is available
    if ! command -v R >/dev/null 2>&1; then
        print_error "R is not available in PATH"
        print_info "Please load R module before running installation, e.g.:"
        print_info "  module load r/4.5.0  # or your platform's R module"
        return 1
    fi
    
    local r_version=$(R --version | head -1)
    print_success "Found R: $r_version"
    
    # Set R_HOME if not already set
    if [[ -z "$R_HOME" ]]; then
        print_info "R_HOME not set, auto-detecting..."
        local detected_r_home=$(R RHOME 2>/dev/null)
        if [[ -n "$detected_r_home" && -d "$detected_r_home" ]]; then
            export R_HOME="$detected_r_home"
            print_success "Set R_HOME=$R_HOME"
        else
            print_warning "Could not detect R_HOME"
            print_info "You may need to set it manually: export R_HOME=\$(R RHOME)"
        fi
    else
        print_success "R_HOME already set: $R_HOME"
    fi
    
    # Add R lib to LD_LIBRARY_PATH if not already there
    if [[ -n "$R_HOME" && -d "$R_HOME/lib" ]]; then
        if [[ ":$LD_LIBRARY_PATH:" != *":$R_HOME/lib:"* ]]; then
            export LD_LIBRARY_PATH="$R_HOME/lib:$LD_LIBRARY_PATH"
            print_info "Added $R_HOME/lib to LD_LIBRARY_PATH"
        fi
    fi
    
    return 0
}

# Function to find symfluence.py (with backward compatibility for CONFLUENCE.py)
find_symfluence_script() {
    local script_dir=$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")
    local search_paths=(
        "${script_dir}/${SYMFLUENCE_SCRIPT}"
        "${script_dir}/../${SYMFLUENCE_SCRIPT}"
        "./${SYMFLUENCE_SCRIPT}"
        "${PWD}/${SYMFLUENCE_SCRIPT}"
    )
    
    # Check for SYMFLUENCE_CODE_DIR first, then fall back to CONFLUENCE_CODE_DIR
    if [[ -n "${SYMFLUENCE_CODE_DIR}" ]]; then
        search_paths=("${SYMFLUENCE_CODE_DIR}/${SYMFLUENCE_SCRIPT}" "${search_paths[@]}")
    elif [[ -n "${CONFLUENCE_CODE_DIR}" ]]; then
        search_paths=("${CONFLUENCE_CODE_DIR}/${SYMFLUENCE_SCRIPT}" "${search_paths[@]}")
    fi
    
    for path in "${search_paths[@]}"; do
        if [[ -f "$path" ]]; then
            echo "$path"
            return 0
        fi
    done
    
    return 1
}

# Function to find suitable Python interpreter
find_python() {
    # Try specific Python versions first (prefer 3.11-3.13)
    local python_candidates=("python3.11" "python3.12" "python3.13" "python3.10" "python3" "python")
    
    for cmd in "${python_candidates[@]}"; do
        if command -v "$cmd" >/dev/null 2>&1; then
            local version=$($cmd -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')" 2>/dev/null)
            if [[ $? -eq 0 ]]; then
                local major=$(echo "$version" | cut -d. -f1)
                local minor=$(echo "$version" | cut -d. -f2)
                
                # Skip Python 3.14+
                if [[ "$major" -eq 3 ]] && [[ "$minor" -gt 13 ]]; then
                    continue
                fi
                
                # Check if version meets minimum requirement
                if $cmd -c "
import sys
current = tuple(map(int, '$version'.split('.')))
required = tuple(map(int, '$MIN_PYTHON_VERSION'.split('.')))
sys.exit(0 if current >= required else 1)
" 2>/dev/null; then
                    echo "$cmd"
                    return 0
                fi
            fi
        fi
    done
    
    return 1
}

# Function to check and activate virtual environment
check_virtual_env() {
    local symfluence_dir=$(dirname "$1")
    local venv_paths=(
        "${symfluence_dir}/venv"
        "${symfluence_dir}/.venv"
        "${symfluence_dir}/env"
        "${symfluence_dir}/.env"
    )
    
    # Check if we're already in a virtual environment
    if [[ -n "${VIRTUAL_ENV}" ]]; then
        print_info "Using active virtual environment: ${VIRTUAL_ENV}"
        return 0
    fi
    
    # Look for virtual environment
    for venv_path in "${venv_paths[@]}"; do
        if [[ -f "${venv_path}/bin/activate" ]]; then
            print_info "Found virtual environment: ${venv_path}"
            print_info "Activating virtual environment..."
            source "${venv_path}/bin/activate"
            
            if [[ -n "$PYTHONPATH" ]]; then
                export PYTHONPATH=""
            fi
            
            return 0
        fi
    done
    
    return 0
}

# Function to show help if symfluence.py is not found
show_symfluence_help() {
    cat << EOF
${SCRIPT_NAME}: SYMFLUENCE Python script not found

This wrapper script looks for symfluence.py in the following locations:
  - Current directory and parent directories
  - Path specified by SYMFLUENCE_CODE_DIR environment variable
  - Path specified by CONFLUENCE_CODE_DIR environment variable (backward compat)

To fix this issue:
1. Run this script from the SYMFLUENCE project directory, or
2. Set the SYMFLUENCE_CODE_DIR environment variable:
   export SYMFLUENCE_CODE_DIR=/path/to/symfluence

For more information about SYMFLUENCE, visit:
https://github.com/DarriEy/symfluence
EOF
}

# Handle wrapper-specific flags
handle_wrapper_flags() {
    case "$1" in
        --wrapper-help)
            cat << EOF
SYMFLUENCE Shell Wrapper Help

This wrapper provides convenient access to SYMFLUENCE without typing 'python symfluence.py'.

Wrapper-specific options:
  --wrapper-help     Show this help message
  --wrapper-info     Show wrapper and environment information
  --wrapper-debug    Run wrapper in debug mode
  --install          Set up Python environment and install external tools

All other options are passed directly to symfluence.py.
See 'symfluence --help' for SYMFLUENCE-specific options.
EOF
            exit 0
            ;;
        --wrapper-info)
            local symfluence_script=$(find_symfluence_script)
            local python_cmd=$(find_python)
            
            echo "SYMFLUENCE Wrapper Information"
            echo "=============================="
            echo "Wrapper script: $(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
            echo "symfluence.py: ${symfluence_script:-'Not found'}"
            echo "Python command: ${python_cmd:-'Not found'}"
            echo "Python version: $(${python_cmd} --version 2>/dev/null || echo 'Unknown')"
            echo "Virtual env: ${VIRTUAL_ENV:-'None active'}"
            echo "Working directory: $(pwd)"
            echo "SYMFLUENCE_CODE_DIR: ${SYMFLUENCE_CODE_DIR:-'Not set'}"
            echo "CONFLUENCE_CODE_DIR (legacy): ${CONFLUENCE_CODE_DIR:-'Not set'}"
            exit 0
            ;;
        --wrapper-debug)
            set -x
            return 1
            ;;
        --install)
            return 1
            ;;
        *)
            return 1
            ;;
    esac
}

# Main execution function
main() {
    local run_install=false
    
    # Handle wrapper-specific flags
    for arg in "$@"; do
        if handle_wrapper_flags "$arg"; then
            return 0
        fi
        if [[ "$arg" == "--install" ]]; then
            run_install=true
        fi
    done
    
    # Find symfluence.py
    local symfluence_script
    if ! symfluence_script=$(find_symfluence_script); then
        print_error "symfluence.py not found"
        echo
        show_symfluence_help
        exit 1
    fi
    
    # Find Python interpreter
    local python_cmd
    if ! python_cmd=$(find_python); then
        print_error "Python ${MIN_PYTHON_VERSION}+ not found"
        print_info "Please install or load Python ${MIN_PYTHON_VERSION} or later"
        exit 1
    fi
    
    local symfluence_dir=$(dirname "$symfluence_script")
    
    # Handle installation mode
    if [[ "$run_install" == "true" ]]; then
        print_info "SYMFLUENCE installation mode"
        echo ""
        print_info "Prerequisites:"
        print_info "  - Python 3.11+"
        print_info "  - R (optional)"
        print_info "  - Required library modules (xz, bzip2, netcdf, gdal, etc.)"
        echo ""
        
        # Check/create venv
        local venv_path="${symfluence_dir}/venv"
        if [[ ! -d "$venv_path" ]]; then
            print_info "Creating Python virtual environment..."
            if ! $python_cmd -m venv "$venv_path"; then
                print_error "Failed to create virtual environment"
                exit 1
            fi
        fi
        
        # Activate and install
        source "${venv_path}/bin/activate"
        
        if [[ -n "$PYTHONPATH" ]]; then
            export PYTHONPATH=""
        fi
        
        print_info "Installing Python dependencies..."
        pip install --upgrade pip
        
        setup_r_environment || print_warning "R setup had issues, continuing..."
        
        if [[ -f "${symfluence_dir}/requirements.txt" ]]; then
            pip install -r "${symfluence_dir}/requirements.txt"
        else
            pip install numpy pandas geopandas rasterio netCDF4 PyYAML shapely rasterstats psutil
        fi
        
        print_success "Python environment setup complete"
        
        # Run external tools installation
        cd "$symfluence_dir"
        print_info "Installing external tools..."
        $python_cmd "$SYMFLUENCE_SCRIPT" --get_executables
        
        print_info "Validating installation..."
        $python_cmd "$SYMFLUENCE_SCRIPT" --validate_binaries
        
        echo ""
        print_success "Installation complete!"
        print_info "To use SYMFLUENCE: source ${venv_path}/bin/activate"
        exit 0
    fi
    
    # For normal execution
    check_virtual_env "$symfluence_script"
    
    if ! python_cmd=$(find_python); then
        print_error "Python ${MIN_PYTHON_VERSION}+ not found"
        exit 1
    fi
    
    # Change to SYMFLUENCE directory
    if [[ "$symfluence_dir" != "." ]]; then
        cd "$symfluence_dir"
    fi
    
    # Execute SYMFLUENCE
    exec "$python_cmd" "$SYMFLUENCE_SCRIPT" "$@"
}

# Trap signals
trap 'echo -e "\nInterrupted"; exit 130' INT TERM

# Run main
main "$@"
