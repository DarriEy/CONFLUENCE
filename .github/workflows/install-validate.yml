name: SYMFLUENCE - Full Install & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: {}

defaults:
  run:
    shell: bash

concurrency:
  group: symfluence-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  install-validate:
    runs-on: ubuntu-22.04
    env:
      TZ: UTC
      CI: "1"
      NONINTERACTIVE: "1"
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/SYMFLUENCE_data

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ----- System deps (always run now) -----
      - name: Install system build deps
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ubuntugis/ppa
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake make pkg-config \
            ninja-build autoconf automake libtool \
            git wget curl unzip tar \
            openmpi-bin libopenmpi-dev \
            gdal-bin libgdal-dev libproj-dev \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev hdf5-tools libudunits2-dev \
            python3-dev python3-pip python3-numpy python3-gdal
          mpicc --version
          mpirun --version
          gdal-config --version

      - name: Configure compiler and library env
        run: |
          set -e
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV
          NETCDF_PREFIX=$(nc-config --prefix 2>/dev/null || echo /usr)
          NETCDF_LIBDIR=$(nc-config --libdir 2>/dev/null || echo /usr/lib/x86_64-linux-gnu)
          NETCDF_INC=$(nc-config --includedir 2>/dev/null || echo /usr/include)
          echo "NETCDF=${NETCDF_PREFIX}" >> $GITHUB_ENV
          echo "NETCDF_FORTRAN=$(nf-config --prefix 2>/dev/null || echo ${NETCDF_PREFIX})" >> $GITHUB_ENV
          echo "NETCDF_DIR=${NETCDF_PREFIX}" >> $GITHUB_ENV
          echo "NETCDF_LIBDIR=${NETCDF_LIBDIR}" >> $GITHUB_ENV
          echo "NETCDF_INCLUDE=${NETCDF_INC}" >> $GITHUB_ENV
          echo "HDF5_ROOT=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV
          echo "HDF5_LIBDIR=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV
          echo "HDF5_INCLUDE_DIR=/usr/include/hdf5/serial" >> $GITHUB_ENV
          echo "UDUNITS2_DIR=$(pkg-config --variable=prefix udunits2 2>/dev/null || echo /usr)" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${NETCDF_LIBDIR}:${HDF5_LIBDIR}:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${NETCDF_LIBDIR}:${HDF5_LIBDIR}:${LIBRARY_PATH}" >> $GITHUB_ENV
          echo "CC=mpicc"  >> $GITHUB_ENV
          echo "CXX=mpicxx" >> $GITHUB_ENV
          NF_FLIBS="$(nf-config --flibs 2>/dev/null || echo "-L${NETCDF_LIBDIR} -lnetcdff")"
          NC_LIBS="$(nc-config --libs  2>/dev/null || echo "-L${NETCDF_LIBDIR} -lnetcdf")"
          H5_LIBS="$(pkg-config --libs hdf5_hl hdf5 2>/dev/null || echo "-L${HDF5_LIBDIR} -lhdf5_hl -lhdf5")"
          echo "FUSE_LIBRARIES=${NF_FLIBS} ${NC_LIBS} ${H5_LIBS}" >> $GITHUB_ENV
          NF_FFLAGS="$(nf-config --fflags 2>/dev/null || true)"
          NC_CFLAGS="$(nc-config --cflags 2>/dev/null || true)"
          H5_CFLAGS="$(pkg-config --cflags hdf5 2>/dev/null || echo "-I${HDF5_INCLUDE_DIR}")"
          echo "FUSE_INCLUDE=${NC_CFLAGS} ${NF_FFLAGS} ${H5_CFLAGS} -I${NETCDF_INCLUDE}" >> $GITHUB_ENV
          echo "FUSE_FFLAGS_EXTRA=-fallow-argument-mismatch -std=legacy -ffree-line-length-none -fmax-errors=0" >> $GITHUB_ENV

      - name: Create /usr/lib64 symlinks for legacy builds (HDF5/NetCDF)
        run: |
          set -e
          sudo mkdir -p /usr/lib64
          for so in /usr/lib/x86_64-linux-gnu/libnetcdf.so* /usr/lib/x86_64-linux-gnu/libnetcdff.so*; do
            [ -e "$so" ] || continue; base=$(basename "$so")
            [ -e "/usr/lib64/${base}" ] || sudo ln -s "$so" "/usr/lib64/${base}" || true
          done
          for so in /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_hl.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_fortran.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5hl_fortran.so*; do
            [ -e "$so" ] || continue; base=$(basename "$so")
            [ -e "/usr/lib64/${base}" ] || sudo ln -s "$so" "/usr/lib64/${base}" || true
          done

      - name: Ensure data dir exists
        run: mkdir -p "${{ env.SYMFLUENCE_DATA }}"

      - name: Full install (build venv + tools)
        env:
          CC: mpicc
          CXX: mpicxx
        run: |
          set -e
          chmod +x ./symfluence
          ./symfluence --install

      - name: Validate binaries
        run: |
          set -e
          . ./venv/bin/activate || . ./.venv/bin/activate
          python --version
          python symfluence.py --validate_binaries

      - name: Verify venv & package import
        run: |
          set -e
          . ./venv/bin/activate || . ./.venv/bin/activate
          which python
          python -c "import symfluence; print('symfluence OK')"

      - name: Wrapper info (with config)
        run: |
          set -eo pipefail
          . ./venv/bin/activate
          echo "---- CONFIG CONTENT ----"
          sed -n '1,200p' 0_config_files/config_ci_bow.yaml || true
          echo "---- WRAPPER INFO ----"
          ./symfluence --wrapper-info --config 0_config_files/config_ci_bow.yaml || true

      - name: Create CI config from template + overrides
        run: |
          set -eo pipefail
          mkdir -p 0_config_files

          # Merge the template with CI overrides via a tiny Python script
          python - <<'PY'
          import os, sys, yaml
          tpl_path = "0_config_files/config_template.yaml"
          out_path = "0_config_files/config_ci_bow.yaml"
          with open(tpl_path, "r") as f:
              cfg = yaml.safe_load(f) or {}

          # Minimal overrides for CI
          cfg["SYMFLUENCE_CODE_DIR"] = os.environ.get("SYMFLUENCE_CODE", "")
          cfg["SYMFLUENCE_DATA_DIR"] = os.environ.get("SYMFLUENCE_DATA", "")
          cfg["DOMAIN_NAME"] = "Bow_at_Banff"
          cfg["DOMAIN_DEFINITION_METHOD"] = "delineate"
          cfg["LOG_LEVEL"] = "INFO"

          with open(out_path, "w") as f:
              yaml.safe_dump(cfg, f, sort_keys=False)

          # Quick sanity checks for keys that must exist
          required = ["DEM_NAME", "SYMFLUENCE_CODE_DIR", "SYMFLUENCE_DATA_DIR", "DOMAIN_NAME", "DOMAIN_DEFINITION_METHOD"]
          missing = [k for k in required if k not in cfg or cfg[k] in ("", None)]
          if missing:
              print("Missing required keys in merged config:", missing, file=sys.stderr)
              sys.exit(1)
          print("Wrote", out_path)
          PY

          echo "---- First 120 lines of merged config ----"
          sed -n '1,120p' 0_config_files/config_ci_bow.yaml


      - name: Run setup_project (absolute config path + diagnostics)
        run: |
          set -eo pipefail
          . ./venv/bin/activate

          CONFIG="${GITHUB_WORKSPACE}/0_config_files/config_ci_bow.yaml"

          echo "Checking config at: ${CONFIG}"
          if [ ! -f "${CONFIG}" ]; then
            echo "‚ùå Config file missing"
            echo "Listing 0_config_files:"
            ls -la "${GITHUB_WORKSPACE}/0_config_files" || true
            exit 1
          fi

          echo "---- CLI HELP (to confirm flags) ----"
          python symfluence.py --help | sed -n '1,120p' || true

          echo "---- Running setup_project ----"
          set +e
          python symfluence.py --config "${CONFIG}" --setup_project \
            > _setup_stdout.log 2> _setup_stderr.log
          STATUS=$?
          set -e

          if [ "$STATUS" -ne 0 ]; then
            echo "‚ùå setup_project failed (exit $STATUS). Showing first 200 lines of logs:"
            echo "---- STDOUT ----"; sed -n '1,200p' _setup_stdout.log || true
            echo "---- STDERR ----"; sed -n '1,200p' _setup_stderr.log || true
            echo "---- Work logs (if any) ----"
            ls -R _workLog_* 2>/dev/null || echo "(no _workLog_* directory created)"
            exit $STATUS
          else
            echo "‚úÖ setup_project finished OK"
          fi



      - name: Assert domain directory exists
        run: |
          set -eo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff"
          if [ -d "$TARGET" ]; then
            echo "‚úÖ Found ${TARGET}"
          else
            echo "‚ùå Expected domain directory at ${TARGET}"
            echo "Listing ${SYMFLUENCE_DATA}:"
            ls -la "${SYMFLUENCE_DATA}" || true
            echo "Tail of setup logs (if present):"
            tail -n 200 _setup_stdout.log 2>/dev/null || true
            tail -n 200 _setup_stderr.log 2>/dev/null || true
            exit 1
          fi

      - name: Copy test data into domain directory
        run: |
          set -eo pipefail
          SRC="${SYMFLUENCE_CODE}/src/data/domain_Bow_at_Banff"
          DEST="${SYMFLUENCE_DATA}/domain_Bow_at_Banff"
          echo "üì¶ Copying test data from ${SRC} ‚Üí ${DEST}"
          if [ -d "${SRC}" ]; then
            mkdir -p "${DEST}"
            cp -a "${SRC}/." "${DEST}/"
            echo "‚úÖ Copied contents:"
            ls -R "${DEST}" || true
          else
            echo "‚ùå Source directory not found: ${SRC}"
            ls -la "${SYMFLUENCE_CODE}/src/data" || true
            exit 1
          fi

      - name: Run --create_pour_point
        run: |
          set -eo pipefail
          . ./venv/bin/activate
          ./symfluence --config 0_config_files/config_ci_bow.yaml --create_pour_point \
            || { echo "create_pour_point failed ‚Äî printing logs:"; ls -R _workLog_* || true; find _workLog_* -type f -maxdepth 2 -print -exec sed -n '1,200p' {} \; || true; exit 1; }

      - name: Assert pour point exists
        run: |
          set -eo pipefail
          BASE="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles/pour_point"
          if compgen -G "${BASE}/Bow_at_Banff_pourPoint."{shp,gpkg,geojson} > /dev/null; then
            echo "‚úÖ Found pour point file in ${BASE}"
            ls -la "${BASE}" || true
          else
            echo "‚ùå Expected pour point file (Bow_at_Banff_pourPoint.{shp|gpkg|geojson}) under ${BASE}"
            ls -la "${BASE}" || true
            exit 1
          fi

      - name: Run --define_domain
        run: |
          set -eo pipefail
          . ./venv/bin/activate
          ./symfluence --config 0_config_files/config_ci_bow.yaml --define_domain \
            || { echo "define_domain failed ‚Äî printing logs:"; ls -R _workLog_* || true; find _workLog_* -type f -maxdepth 2 -print -exec sed -n '1,200p' {} \; || true; exit 1; }

      - name: Assert define_domain output exists
        run: |
          set -eo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles/river_basins/Bow_at_Banff_riverBasins.shp"
          if [ -f "$TARGET" ]; then
            echo "‚úÖ Found domain shapefile: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles" || true
            exit 1
          fi

      - name: Run --discretize_domain
        run: |
          set -eo pipefail
          . ./venv/bin/activate
          ./symfluence --config 0_config_files/config_ci_bow.yaml --discretize_domain \
            || { echo "discretize_domain failed ‚Äî printing logs:"; ls -R _workLog_* || true; find _workLog_* -type f -maxdepth 2 -print -exec sed -n '1,200p' {} \; || true; exit 1; }

      - name: Assert discretize_domain output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles/catchment/Bow_at_Banff_HRUs_GRUs.shp"
          if [ -f "$TARGET" ]; then
            echo "‚úÖ Found discretization shapefile: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles" || true
            exit 1
          fi

      # Only runs if something failed above
      - name: Upload step-test artifacts (on fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: step-test-artifacts
          path: |
            _workLog_*/**
            ${{ env.SYMFLUENCE_DATA }}/domain_Bow_at_Banff/**
          if-no-files-found: ignore

      - name: List created domain content (for logs)
        run: |
          set -e
          ls -la "${SYMFLUENCE_DATA}" || true
          ls -la "${SYMFLUENCE_DATA}"/domain_* || true
