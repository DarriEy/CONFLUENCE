name: SYMFLUENCE - Full Install & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: {}

jobs:
  install-validate:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      CI: "1"
      NONINTERACTIVE: "1"
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/SYMFLUENCE_data

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # -------------------------------
      # Core system build dependencies
      # -------------------------------
      - name: Install system build deps
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake make pkg-config \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev hdf5-tools \
            libudunits2-dev \
            libsqlite3-dev \
            libopenblas-dev liblapack-dev \
            libgdal-dev libproj-dev gdal-bin \
            libgsl-dev libmetis-dev \
            curl ca-certificates \
            r-base r-base-dev \
            mpich libmpich-dev


      # ------------------------------------------------
      # Env discovery for NetCDF / HDF5 / UDUNITS (Ubuntu)
      # ------------------------------------------------
      - name: Configure compiler and library env
        shell: bash
        run: |
          set -e

          # pkg-config search paths (cover Ubuntu placements)
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV

          # ---- NetCDF discovery (C & Fortran) ----
          NETCDF_PREFIX=$(nc-config --prefix 2>/dev/null || echo /usr)
          NETCDF_LIBDIR=$(nc-config --libdir 2>/dev/null || echo /usr/lib/x86_64-linux-gnu)
          NETCDF_INC=$(nc-config --includedir 2>/dev/null || echo /usr/include)

          echo "NETCDF=${NETCDF_PREFIX}" >> $GITHUB_ENV
          echo "NETCDF_FORTRAN=$(nf-config --prefix 2>/dev/null || echo ${NETCDF_PREFIX})" >> $GITHUB_ENV
          echo "NETCDF_DIR=${NETCDF_PREFIX}" >> $GITHUB_ENV
          echo "NETCDF_LIBDIR=${NETCDF_LIBDIR}" >> $GITHUB_ENV
          echo "NETCDF_INCLUDE=${NETCDF_INC}" >> $GITHUB_ENV

          # ---- HDF5 discovery (Ubuntu 'serial' multiarch layout) ----
          # Libraries live here; includes under /usr/include/hdf5/serial
          echo "HDF5_ROOT=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV
          echo "HDF5_LIBDIR=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV
          echo "HDF5_INCLUDE_DIR=/usr/include/hdf5/serial" >> $GITHUB_ENV

          # UDUNITS2 prefix (helps CMake find scripts)
          echo "UDUNITS2_DIR=$(pkg-config --variable=prefix udunits2 2>/dev/null || echo /usr)" >> $GITHUB_ENV

          # General linker paths for old Makefiles
          echo "LD_LIBRARY_PATH=${NETCDF_LIBDIR}:${HDF5_LIBDIR}:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${NETCDF_LIBDIR}:${HDF5_LIBDIR}:${LIBRARY_PATH}" >> $GITHUB_ENV

          # R for rpy2 (if present)
          if command -v R >/dev/null 2>&1; then
            echo "R_HOME=$(R RHOME)" >> $GITHUB_ENV
            echo "PATH=$(dirname "$(command -v R)"):${PATH}" >> $GITHUB_ENV
          fi

          # MPI compilers for TauDEM/CMake discovery
          echo "CC=mpicc"  >> $GITHUB_ENV
          echo "CXX=mpicxx" >> $GITHUB_ENV

          # ------- Convenience flags for FUSE (used if your wrapper picks them up) -------
          NF_FLIBS="$(nf-config --flibs 2>/dev/null || echo "-L${NETCDF_LIBDIR} -lnetcdff")"
          NC_LIBS="$(nc-config --libs  2>/dev/null || echo "-L${NETCDF_LIBDIR} -lnetcdf")"
          H5_LIBS="$(pkg-config --libs hdf5_hl hdf5 2>/dev/null || echo "-L${HDF5_LIBDIR} -lhdf5_hl -lhdf5")"
          echo "FUSE_LIBRARIES=${NF_FLIBS} ${NC_LIBS} ${H5_LIBS}" >> $GITHUB_ENV

          NF_FFLAGS="$(nf-config --fflags 2>/dev/null || true)"
          NC_CFLAGS="$(nc-config --cflags 2>/dev/null || true)"
          H5_CFLAGS="$(pkg-config --cflags hdf5 2>/dev/null || echo "-I${HDF5_INCLUDE_DIR}")"
          echo "FUSE_INCLUDE=${NC_CFLAGS} ${NF_FFLAGS} ${H5_CFLAGS} -I${NETCDF_INCLUDE}" >> $GITHUB_ENV

          # Extra Fortran compatibility for old NetCDF calls
          echo "FUSE_FFLAGS_EXTRA=-fallow-argument-mismatch -std=legacy -ffree-line-length-none -fmax-errors=0" >> $GITHUB_ENV

          # Debug prints (will show in logs)
          echo "NETCDF_PREFIX=${NETCDF_PREFIX}"
          echo "NETCDF_LIBDIR=${NETCDF_LIBDIR}"
          echo "NETCDF_INCLUDE=${NETCDF_INC}"
          echo "HDF5_LIBDIR=${HDF5_LIBDIR}"
          echo "HDF5_INCLUDE_DIR=${HDF5_INCLUDE_DIR}"
          echo "FUSE_LIBRARIES=${FUSE_LIBRARIES}"
          echo "FUSE_INCLUDE=${FUSE_INCLUDE}"



      # -----------------------------------------------------------------
      # Compatibility shim: some legacy makefiles look in /usr/lib64
      # -----------------------------------------------------------------
      - name: Create /usr/lib64 symlinks for legacy builds (HDF5/NetCDF)
        run: |
          set -e
          sudo mkdir -p /usr/lib64

          # Mirror NetCDF libs
          for so in /usr/lib/x86_64-linux-gnu/libnetcdf.so* /usr/lib/x86_64-linux-gnu/libnetcdff.so*; do
            [ -e "$so" ] || continue
            base=$(basename "$so")
            if [ ! -e "/usr/lib64/${base}" ]; then
              sudo ln -s "$so" "/usr/lib64/${base}" || true
            fi
          done

          # Mirror HDF5 libs (Ubuntu keeps them under hdf5/serial)
          for so in /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_hl.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_fortran.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5hl_fortran.so*; do
            [ -e "$so" ] || continue
            base=$(basename "$so")
            if [ ! -e "/usr/lib64/${base}" ]; then
              sudo ln -s "$so" "/usr/lib64/${base}" || true
            fi
          done


      # --------------------
      # Sanity prints (logs)
      # --------------------
      - name: Print discovery info
        run: |
          which nc-config || true
          which nf-config || true
          pkg-config --modversion hdf5 || true
          pkg-config --modversion udunits2 || true
          echo "nc-config --libs: $(nc-config --libs 2>/dev/null || echo 'N/A')"
          echo "nf-config --flibs: $(nf-config --flibs 2>/dev/null || echo 'N/A')"
          echo "pkg-config hdf5 libs: $(pkg-config --libs hdf5 2>/dev/null || echo 'N/A')"
          echo "pkg-config udunits2 cflags: $(pkg-config --cflags udunits2 2>/dev/null || echo 'N/A')"

      # --------------------------
      # Run your full installation
      # --------------------------
      - name: Full install (build venv + tools)
        shell: bash
        env:
          CMAKE_PREFIX_PATH: "${{ env.UDUNITS2_DIR }}:${{ env.HDF5_ROOT }}:${{ env.NETCDF }}:${{ env.NETCDF_FORTRAN }}"
          UDUNITS2_DIR: "${{ env.UDUNITS2_DIR }}"
          HDF5_ROOT: "${{ env.HDF5_ROOT }}"
          HDF5_LIBDIR: "${{ env.HDF5_LIBDIR }}"
          HDF5_INCLUDE_DIR: "${{ env.HDF5_INCLUDE_DIR }}"
          NETCDF: "${{ env.NETCDF }}"
          NETCDF_FORTRAN: "${{ env.NETCDF_FORTRAN }}"
          NETCDF_DIR: "${{ env.NETCDF_DIR }}"
          NETCDF_LIBDIR: "${{ env.NETCDF_LIBDIR }}"
          NETCDF_INCLUDE: "${{ env.NETCDF_INCLUDE }}"
          # FUSE build helpers (your wrapper can read these if present)
          FUSE_LIBRARIES: "${{ env.FUSE_LIBRARIES }}"
          FUSE_INCLUDE: "${{ env.FUSE_INCLUDE }}"
          FUSE_FFLAGS_EXTRA: "${{ env.FUSE_FFLAGS_EXTRA }}"
          # MPI compilers for TauDEM
          CC: mpicc
          CXX: mpicxx
        run: |
          set -e
          echo "SYMFLUENCE_CODE: ${SYMFLUENCE_CODE}"
          echo "SYMFLUENCE_DATA: ${SYMFLUENCE_DATA}"
          mkdir -p "${SYMFLUENCE_DATA}"
          chmod +x ./symfluence
          ./symfluence --install


      # ----------------
      # Validate binaries
      # ----------------
      - name: Validate
        shell: bash
        run: |
          set -e
          chmod +x ./symfluence
          ./symfluence --validate

      # --------------------------
      # Upload logs on failure only
      # --------------------------
      - name: Upload build logs (on fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: symfluence-build-logs
          path: |
            **/build/**/CMakeFiles/CMakeOutput.log
            **/build/**/CMakeFiles/CMakeError.log
            **/logs/**
            **/*build*.log
            **/cmake_build/**/*.log
          if-no-files-found: warn
