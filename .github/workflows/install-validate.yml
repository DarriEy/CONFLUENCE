name: SYMFLUENCE - Full Install & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: {}

jobs:
  install-validate:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      CI: "1"
      NONINTERACTIVE: "1"
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/SYMFLUENCE_data

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # -------------------------------
      # Core system build dependencies
      # -------------------------------
      - name: Install system build deps
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake make pkg-config \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev \
            libudunits2-dev \
            libsqlite3-dev \
            libopenblas-dev liblapack-dev \
            libgdal-dev libproj-dev gdal-bin \
            curl ca-certificates \
            r-base r-base-dev \
            mpich libmpich-dev

      # ------------------------------------------------
      # Env discovery for NetCDF / HDF5 / UDUNITS (Ubuntu)
      # ------------------------------------------------
      - name: Configure compiler and library env
        shell: bash
        run: |
          set -e
          # pkg-config search paths
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV

          # NetCDF prefixes
          echo "NETCDF=$(nc-config --prefix 2>/dev/null || echo /usr)" >> $GITHUB_ENV
          echo "NETCDF_FORTRAN=$(nf-config --prefix 2>/dev/null || echo /usr)" >> $GITHUB_ENV

          # IMPORTANT: HDF5 lives under the 'serial' multiarch prefix on Ubuntu
          # This is where libhdf5(.so) and libhdf5_hl(.so) actually are.
          echo "HDF5_ROOT=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV

          # UDUNITS2 prefix (nice hint for CMake find scripts)
          echo "UDUNITS2_DIR=$(pkg-config --variable=prefix udunits2 2>/dev/null || echo /usr)" >> $GITHUB_ENV

          # Linker search dirs (for old Makefiles)
          NC_LIBDIR=$(nc-config --libdir 2>/dev/null || echo /usr/lib/x86_64-linux-gnu)
          echo "LD_LIBRARY_PATH=${NC_LIBDIR}:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${NC_LIBDIR}:${LIBRARY_PATH}" >> $GITHUB_ENV

          # R for rpy2
          if command -v R >/dev/null 2>&1; then
            echo "R_HOME=$(R RHOME)" >> $GITHUB_ENV
            echo "PATH=$(dirname "$(command -v R)"):${PATH}" >> $GITHUB_ENV
          fi

          # Make MPI compilers explicit for TauDEM/CMake discovery
          echo "CC=mpicc"  >> $GITHUB_ENV
          echo "CXX=mpicxx" >> $GITHUB_ENV


      # -----------------------------------------------------------------
      # Compatibility shim: some legacy makefiles look in /usr/lib64
      # -----------------------------------------------------------------
      - name: Create /usr/lib64 symlinks for legacy builds (HDF5/NetCDF)
        run: |
          set -e
          if [ ! -d /usr/lib64 ]; then
            sudo mkdir -p /usr/lib64
          fi
          for lib in hdf5 hdf5_hl netcdf netcdff; do
            for so in /usr/lib/x86_64-linux-gnu/lib${lib}.so*; do
              base=$(basename "$so")
              if [ ! -e "/usr/lib64/${base}" ]; then
                sudo ln -s "$so" "/usr/lib64/${base}" || true
              fi
            done
          done

      # --------------------
      # Sanity prints (logs)
      # --------------------
      - name: Print discovery info
        run: |
          which nc-config || true
          which nf-config || true
          pkg-config --modversion hdf5 || true
          pkg-config --modversion udunits2 || true
          echo "nc-config --libs: $(nc-config --libs 2>/dev/null || echo 'N/A')"
          echo "nf-config --flibs: $(nf-config --flibs 2>/dev/null || echo 'N/A')"
          echo "pkg-config hdf5 libs: $(pkg-config --libs hdf5 2>/dev/null || echo 'N/A')"
          echo "pkg-config udunits2 cflags: $(pkg-config --cflags udunits2 2>/dev/null || echo 'N/A')"

      # --------------------------
      # Run your full installation
      # --------------------------
      - name: Full install (build venv + tools)
        shell: bash
        env:
          CMAKE_PREFIX_PATH: "${{ env.UDUNITS2_DIR }}:${{ env.HDF5_ROOT }}:${{ env.NETCDF }}:${{ env.NETCDF_FORTRAN }}"
          UDUNITS2_DIR: "${{ env.UDUNITS2_DIR }}"
          HDF5_ROOT: "${{ env.HDF5_ROOT }}"
          NETCDF: "${{ env.NETCDF }}"
          NETCDF_FORTRAN: "${{ env.NETCDF_FORTRAN }}"
          # MPI compilers for TauDEM
          CC: mpicc
          CXX: mpicxx
        run: |
          set -e
          echo "SYMFLUENCE_CODE: ${SYMFLUENCE_CODE}"
          echo "SYMFLUENCE_DATA: ${SYMFLUENCE_DATA}"
          mkdir -p "${SYMFLUENCE_DATA}"
          chmod +x ./symfluence
          ./symfluence --install

      # ----------------
      # Validate binaries
      # ----------------
      - name: Validate
        shell: bash
        run: |
          set -e
          chmod +x ./symfluence
          ./symfluence --validate

      # --------------------------
      # Upload logs on failure only
      # --------------------------
      - name: Upload build logs (on fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: symfluence-build-logs
          path: |
            **/build/**/CMakeFiles/CMakeOutput.log
            **/build/**/CMakeFiles/CMakeError.log
            **/logs/**
            **/*build*.log
            **/cmake_build/**/*.log
          if-no-files-found: warn
