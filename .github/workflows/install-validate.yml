name: SYMFLUENCE - Full Install & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: {}

defaults:
  run:
    shell: bash

concurrency:
  group: symfluence-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  install-validate:
    runs-on: ubuntu-22.04
    env:
      TZ: UTC
      CI: "1"
      NONINTERACTIVE: "1"
      SYMFLUENCE_CODE: ${{ github.workspace }}
      SYMFLUENCE_DATA: ${{ github.workspace }}/SYMFLUENCE_data

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ----- System deps (always run now) -----
      - name: Install system build deps
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ubuntugis/ppa
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gfortran cmake make pkg-config \
            ninja-build autoconf automake libtool \
            git wget curl unzip tar \
            openmpi-bin libopenmpi-dev \
            gdal-bin libgdal-dev libproj-dev \
            libnetcdf-dev libnetcdff-dev \
            libhdf5-dev hdf5-tools libudunits2-dev \
            python3-dev python3-pip python3-numpy python3-gdal
          mpicc --version
          mpirun --version
          gdal-config --version

      - name: Configure compiler and library env
        run: |
          set -e
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV
          NETCDF_PREFIX=$(nc-config --prefix 2>/dev/null || echo /usr)
          NETCDF_LIBDIR=$(nc-config --libdir 2>/dev/null || echo /usr/lib/x86_64-linux-gnu)
          NETCDF_INC=$(nc-config --includedir 2>/dev/null || echo /usr/include)
          echo "NETCDF=${NETCDF_PREFIX}" >> $GITHUB_ENV
          echo "NETCDF_FORTRAN=$(nf-config --prefix 2>/dev/null || echo ${NETCDF_PREFIX})" >> $GITHUB_ENV
          echo "NETCDF_DIR=${NETCDF_PREFIX}" >> $GITHUB_ENV
          echo "NETCDF_LIBDIR=${NETCDF_LIBDIR}" >> $GITHUB_ENV
          echo "NETCDF_INCLUDE=${NETCDF_INC}" >> $GITHUB_ENV
          echo "HDF5_ROOT=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV
          echo "HDF5_LIBDIR=/usr/lib/x86_64-linux-gnu/hdf5/serial" >> $GITHUB_ENV
          echo "HDF5_INCLUDE_DIR=/usr/include/hdf5/serial" >> $GITHUB_ENV
          echo "UDUNITS2_DIR=$(pkg-config --variable=prefix udunits2 2>/dev/null || echo /usr)" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${NETCDF_LIBDIR}:${HDF5_LIBDIR}:${LD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${NETCDF_LIBDIR}:${HDF5_LIBDIR}:${LIBRARY_PATH}" >> $GITHUB_ENV
          echo "CC=mpicc"  >> $GITHUB_ENV
          echo "CXX=mpicxx" >> $GITHUB_ENV
          NF_FLIBS="$(nf-config --flibs 2>/dev/null || echo "-L${NETCDF_LIBDIR} -lnetcdff")"
          NC_LIBS="$(nc-config --libs  2>/dev/null || echo "-L${NETCDF_LIBDIR} -lnetcdf")"
          H5_LIBS="$(pkg-config --libs hdf5_hl hdf5 2>/dev/null || echo "-L${HDF5_LIBDIR} -lhdf5_hl -lhdf5")"
          echo "FUSE_LIBRARIES=${NF_FLIBS} ${NC_LIBS} ${H5_LIBS}" >> $GITHUB_ENV
          NF_FFLAGS="$(nf-config --fflags 2>/dev/null || true)"
          NC_CFLAGS="$(nc-config --cflags 2>/dev/null || true)"
          H5_CFLAGS="$(pkg-config --cflags hdf5 2>/dev/null || echo "-I${HDF5_INCLUDE_DIR}")"
          echo "FUSE_INCLUDE=${NC_CFLAGS} ${NF_FFLAGS} ${H5_CFLAGS} -I${NETCDF_INCLUDE}" >> $GITHUB_ENV
          echo "FUSE_FFLAGS_EXTRA=-fallow-argument-mismatch -std=legacy -ffree-line-length-none -fmax-errors=0" >> $GITHUB_ENV

      - name: Create /usr/lib64 symlinks for legacy builds (HDF5/NetCDF)
        run: |
          set -e
          sudo mkdir -p /usr/lib64
          for so in /usr/lib/x86_64-linux-gnu/libnetcdf.so* /usr/lib/x86_64-linux-gnu/libnetcdff.so*; do
            [ -e "$so" ] || continue; base=$(basename "$so")
            [ -e "/usr/lib64/${base}" ] || sudo ln -s "$so" "/usr/lib64/${base}" || true
          done
          for so in /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_hl.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5_fortran.so* \
                    /usr/lib/x86_64-linux-gnu/hdf5/serial/libhdf5hl_fortran.so*; do
            [ -e "$so" ] || continue; base=$(basename "$so")
            [ -e "/usr/lib64/${base}" ] || sudo ln -s "$so" "/usr/lib64/${base}" || true
          done

      - name: Ensure data dir exists
        run: mkdir -p "${{ env.SYMFLUENCE_DATA }}"

      - name: Full install (build venv + tools)
        env:
          CC: mpicc
          CXX: mpicxx
        run: |
          set -e
          chmod +x ./symfluence
          ./symfluence --install

      - name: Fix TauDEM permissions and verify execution
        run: |
          set -e
          TAUDEM_DIR="${SYMFLUENCE_DATA}/installs/TauDEM/bin"
          
          # Make all TauDEM binaries executable
          chmod +x ${TAUDEM_DIR}/*
          
          echo "=== Testing TauDEM binary directly ==="
          ${TAUDEM_DIR}/pitremove -h || echo "pitremove help returned: $?"
          
          echo "=== Testing with mpirun ==="
          mpirun -n 1 ${TAUDEM_DIR}/pitremove -h || echo "mpirun pitremove returned: $?"
          
          echo "=== Checking library dependencies ==="
          ldd ${TAUDEM_DIR}/pitremove || true

      - name: Debug TauDEM executable
        run: |
          set -e
          TAUDEM="${SYMFLUENCE_DATA}/installs/TauDEM/bin/pitremove"
          
          echo "=== File info ==="
          ls -lah $TAUDEM
          file $TAUDEM
          
          echo "=== Library dependencies ==="
          ldd $TAUDEM
          
          echo "=== Can we execute it? ==="
          $TAUDEM -h 2>&1 || echo "Exit code: $?"

      - name: Validate binaries
        run: |
          set -e
          . ./venv/bin/activate || . ./.venv/bin/activate
          python --version
          python symfluence.py --validate_binaries

      - name: Verify venv & package import
        run: |
          set -euo pipefail
          PY="./venv/bin/python"
          "$PY" --version
          "$PY" -c "import symfluence; print('symfluence OK')"

      - name: Create CI config from template (no external deps)
        run: |
          set -euo pipefail
          mkdir -p 0_config_files
          # Guard: ensure template exists
          test -f 0_config_files/config_template.yaml || { echo "Missing 0_config_files/config_template.yaml"; ls -la 0_config_files || true; exit 1; }
          cp 0_config_files/config_template.yaml 0_config_files/config_ci_bow.yaml
          cat >> 0_config_files/config_ci_bow.yaml <<'YAML'
          # --- CI overrides (last wins) ---
          SYMFLUENCE_CODE_DIR: "${{ env.SYMFLUENCE_CODE }}"
          SYMFLUENCE_DATA_DIR: "${{ env.SYMFLUENCE_DATA }}"
          DOMAIN_NAME: "Bow_at_Banff"
          DOMAIN_DEFINITION_METHOD: "lumped"
          LOG_LEVEL: "INFO"
          YAML

          echo "---- First 200 lines of merged config_ci_bow.yaml ----"
          sed -n '1,200p' 0_config_files/config_ci_bow.yaml

      - name: Wrapper info (with config)
        run: |
          set -euo pipefail
          ./symfluence --wrapper-info --config 0_config_files/config_ci_bow.yaml || true

      - name: Run --setup_project (direct venv probe + wrapper)
        run: |
          set -euo pipefail

          echo "---- sanity: config exists? ----"
          ls -la 0_config_files
          sed -n '1,120p' 0_config_files/config_ci_bow.yaml

          echo "---- PROBE A: run via venv python (should produce logs) ----"
          set +e
          ./venv/bin/python symfluence.py --config 0_config_files/config_ci_bow.yaml --setup_project \
            > _setup_stdout_A.log 2> _setup_stderr_A.log
          rcA=$?
          set -e
          echo "rcA=$rcA"
          echo "---- STDOUT A (head) ----"; sed -n '1,120p' _setup_stdout_A.log || true
          echo "---- STDERR A (head) ----"; sed -n '1,120p' _setup_stderr_A.log || true

          echo "---- PROBE B: run via wrapper (should match A) ----"
          set +e
          ./symfluence --config 0_config_files/config_ci_bow.yaml --setup_project \
            > _setup_stdout_B.log 2> _setup_stderr_B.log
          rcB=$?
          set -e
          echo "rcB=$rcB"
          echo "---- STDOUT B (head) ----"; sed -n '1,120p' _setup_stdout_B.log || true
          echo "---- STDERR B (head) ----"; sed -n '1,120p' _setup_stderr_B.log || true

          # Fail if wrapper fails but direct venv python works
          if [ "$rcA" -eq 0 ] && [ "$rcB" -ne 0 ]; then
            echo "‚ùå Wrapper failed but direct venv python succeeded: wrapper needs a fix"
            exit $rcB
          fi

          if [ "$rcA" -ne 0 ]; then
            echo "‚ùå Even direct venv python failed ‚Äî not a wrapper problem"
            exit $rcA
          fi

          echo "‚úÖ setup_project OK (via both paths)"


      - name: Assert domain directory exists
        run: |
          set -eo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff"
          if [ -d "$TARGET" ]; then
            echo "‚úÖ Found ${TARGET}"
          else
            echo "‚ùå Expected domain directory at ${TARGET}"
            ls -la "${SYMFLUENCE_DATA}" || true
            exit 1
          fi

      - name: Copy test data into domain directory
        run: |
          set -eo pipefail
          SRC="${SYMFLUENCE_CODE}/src/data/domain_Bow_at_Banff"
          DEST="${SYMFLUENCE_DATA}/domain_Bow_at_Banff"
          echo "üì¶ Copying test data from ${SRC} ‚Üí ${DEST}"
          if [ -d "${SRC}" ]; then
            mkdir -p "${DEST}"
            cp -a "${SRC}/." "${DEST}/"
            echo "‚úÖ Copied contents:"
            ls -R "${DEST}" || true
          else
            echo "‚ùå Source directory not found: ${SRC}"
            ls -la "${SYMFLUENCE_CODE}/src/data" || true
            exit 1
          fi

      - name: Run --create_pour_point
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --create_pour_point 

      - name: Assert pour point exists
        run: |
          set -eo pipefail
          BASE="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles/pour_point"
          if compgen -G "${BASE}/Bow_at_Banff_pourPoint."{shp,gpkg,geojson} > /dev/null; then
            echo "‚úÖ Found pour point file in ${BASE}"
            ls -la "${BASE}" || true
          else
            echo "‚ùå Expected pour point file (Bow_at_Banff_pourPoint.{shp|gpkg|geojson}) under ${BASE}"
            ls -la "${BASE}" || true
            exit 1
          fi

      - name: Run --define_domain
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --define_domain 

      - name: Assert define_domain output exists
        run: |
          set -eo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles/river_basins/Bow_at_Banff_riverBasins_lumped.shp"
          if [ -f "$TARGET" ]; then
            echo "‚úÖ Found domain shapefile: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles" || true
            exit 1
          fi

      - name: Run --discretize_domain
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --discretize_domain || true

      - name: Assert discretize_domain output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles/catchment/Bow_at_Banff_HRUs_GRUs.shp"
          if [ -f "$TARGET" ]; then
            echo "‚úÖ Found discretization shapefile: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/shapefiles" || true
            exit 1
          fi

      - name: Run --model_agnostic_preprocessing
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --model_agnostic_preprocessing || true

      - name: Assert --model_agnostic_preprocessing output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/forcing/basin_averaged_data/"
          if [ -d "$TARGET" ]; then
            echo "‚úÖ Found basin averaged data: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/forcing/" || true
            exit 1
          fi

      - name: Run ---model_specific_preprocessing
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --model_specific_preprocessing || true

      - name: Assert --model_specific_preprocessing output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/forcing/SUMMA_input/"
          if [ -d "$TARGET" ]; then
            echo "‚úÖ Found SUMMA_input data: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/forcing/" || true
            exit 1
          fi

      - name: Run --run_model
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --run_model || true

      - name: Assert --run_model output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/simulations/run_1/SUMMA/run_1_timestep.nc"
          if [ -f "$TARGET" ]; then
            echo "‚úÖ Found SUMMA output data: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/simulations/run_1/SUMMA/" || true
            exit 1
          fi

      - name: Run --calibrate_model
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --calibrate_model || true

      - name: Assert --calibrate_model output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/simulations/run_de/"
          if [ -d "$TARGET" ]; then
            echo "‚úÖ Found calibration output target: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/simulations/" || true
            exit 1
          fi

      - name: Run --run_benchmarking
        run: |
          set -eo pipefail
          ./symfluence --config 0_config_files/config_ci_bow.yaml --run_benchmarking || true

      - name: Assert --run_benchmarking output exists
        run: |
          set -euo pipefail
          TARGET="${SYMFLUENCE_DATA}/domain_Bow_at_Banff/evaluation/benchmark_scores.csv"
          if [ -f "$TARGET" ]; then
            echo "‚úÖ Found benchmark output target: ${TARGET}"
          else
            echo "‚ùå Expected output not found: ${TARGET}"
            ls -R "${SYMFLUENCE_DATA}/domain_Bow_at_Banff/evaluation/" || true
            exit 1
          fi

      - name: Upload step-test artifacts (on fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: step-test-artifacts
          path: |
            _workLog_*/**
            ${{ env.SYMFLUENCE_DATA }}/domain_Bow_at_Banff/**
          if-no-files-found: ignore

      - name: List created domain content (for logs)
        run: |
          set -e
          ls -la "${SYMFLUENCE_DATA}" || true
          ls -la "${SYMFLUENCE_DATA}"/domain_* || true
